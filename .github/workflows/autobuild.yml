#### Automatically build and upload releases to GitHub ####

on:
  workflow_dispatch:
  push:
    tags:
      - "r*"
    branches: 
      - master
  pull_request: # The branches below must be a subset of the branches in "push"
    branches: 
      - master
  schedule:
    - cron: '23 11 * * 6'
name:                               Auto-Build
jobs:
  create_release:
     name:                          Create release
     runs-on:                       ubuntu-latest
     outputs:
      publish_to_release:           ${{ steps.jamulus-build-vars.outputs.PUBLISH_TO_RELEASE }}
      upload_url:                   ${{ steps.create_release_step.outputs.upload_url }}
      version:                      ${{ steps.jamulus-build-vars.outputs.JAMULUS_VERSION }}
      version_name:                 ${{ steps.jamulus-build-vars.outputs.RELEASE_VERSION_NAME }}
      x_github_workspace:           ${{ steps.jamulus-build-vars.outputs.X_GITHUB_WORKSPACE }} #needed, because matrix can not directly access ${{ github.workspace }} aparrently
      build_flatpack:               ${{ steps.jamulus-build-vars.outputs.BUILD_FLATPACK }}
      

     steps:
         # Checkout code
         - name:                    Checkout code
           uses:                    actions/checkout@v2

         # Set variables
         # Determine release / pre-release
         - name:                    Get Jamulus build info, determine actions & variables
           run:                     python3 ${{ github.workspace }}/.github/actions_scripts/analyse_git_reference.py
           id:                      jamulus-build-vars

         # remove release, if it exists (with this releasetag)
         - name:                    Remove release, if existing (for latest and branches)
           if:                      ${{ contains(steps.jamulus-build-vars.outputs.PUBLISH_TO_RELEASE, 'true') }}
           continue-on-error:       true
           uses:                    dev-drprasad/delete-tag-and-release@v0.1.2
           with:
             delete_release:        false
             tag_name:              ${{ steps.jamulus-build-vars.outputs.RELEASE_TAG }}
           env:
             GITHUB_TOKEN:          ${{ secrets.GITHUB_TOKEN }}
         # create release (empty, filled by next jobs)
         - name:                    'Create Release ${{steps.jamulus-build-vars.outputs.RELEASE_TAG}}  {{steps.jamulus-build-vars.outputs.RELEASE_TITLE}}'
           if:                      ${{ contains(steps.jamulus-build-vars.outputs.PUBLISH_TO_RELEASE, 'true') }}
           id:                      create_release_step
           uses:                    actions/create-release@v1
           env:
             GITHUB_TOKEN:          ${{ secrets.GITHUB_TOKEN }}
           with:
             tag_name:              ${{ steps.jamulus-build-vars.outputs.RELEASE_TAG }}
             release_name:          ${{ steps.jamulus-build-vars.outputs.RELEASE_TITLE }}
             body_path:             ${{ github.workspace }}/autoLatestChangelog.md
             prerelease:            ${{ steps.jamulus-build-vars.outputs.IS_PRERELEASE }}
             draft:                 false


         ### CANCEL ### can be used for development concerning release-creation
         #- name:                    Cancelthrougherroe
         #  run:                     myundefinedfunction


  release_assets:
    name:                           Build assets for ${{ matrix.config.config_name }}
    needs:                          create_release
    strategy:
      fail-fast:                    false
      matrix: # Think of this like a foreach loop. Basically runs the steps with every combination of the contents of this. More info: https://docs.github.com/en/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
        config:
        
           - config_name:           Linux (codeQL)
             target_os:             linux
             building_on_os:        ubuntu-18.04
             asset_path:            deploy/Jamulus_amd64.deb
             asset_name:            jamulus_${{ needs.create_release.outputs.version_name }}_ubuntu_amd64.deb
             cmd1_prebuild:         "sh autobuild/linux/codeQL/auto_1_prepare.sh "
             cmd2_build:            "sh autobuild/linux/codeQL/auto_2_build_qt_project.sh "
             cmd3_postbuild:        false 
             uses_codeql:           true
             artifact_severity:     "warn"
        
           - config_name:           Linux (artifacts)
             target_os:             linux
             building_on_os:        ubuntu-18.04
             asset_path:            deploy/*
             asset_name:            jamulus_${{ needs.create_release.outputs.version_name }}_ubuntu_amd64.deb
             cmd1_prebuild:         "sh autobuild/linux/normal/autobuild_deb_1_prepare.sh "
             cmd2_build:            "sh autobuild/linux/normal/autobuild_deb_2_build.sh "
             cmd3_postbuild:        "sh autobuild/linux/normal/autobuild_deb_3_copy_files.sh "
             uses_codeql:           true
             artifact_severity:     "error"
             
           #- config_name:           Linux (artifact headless)
           #  target_os:             linux
           #  building_on_os:        ubuntu-18.04
           #  asset_path:            deploy/Jamulus_headless_amd64.deb
           #  asset_name:            jamulus_headless_${{ needs.create_release.outputs.version_name #}}_ubuntu_amd64.deb
           #  cmd1_prebuild:         "sh autobuild/linux/normal/auto_1_prepare.sh ${{ needs.create_release.outputs.x_github_workspace }}"
           #  cmd2_build:            "sh autobuild/linux/normal/auto_2_build_qt_project.sh ${{ needs.create_release.outputs.x_github_workspace }}"
           #  cmd3_postbuild:        false
             
           - config_name:           MacOS (artifact)
             target_os:             macos
             building_on_os:        macos-10.15
             asset_path:            deploy/Jamulus-installer-mac.dmg
             asset_name:            jamulus_${{ needs.create_release.outputs.version_name }}_mac.dmg
             cmd1_prebuild:         false
             cmd2_build:            sh mac/autorelease_mac.sh 
             cmd3_postbuild:        false
             uses_codeql:           true
             artifact_severity:     "warn"
             
           - config_name:           Windows (artifact+codeql)
             target_os:             windows
             building_on_os:        windows-latest
             asset_path:            deploy\Jamulus-installer-win.exe
             asset_name:            jamulus_${{ needs.create_release.outputs.version_name }}_win.exe
             cmd1_prebuild:         powershell ./autobuild/windows/installer/auto_1_prepare.ps1 -sourcepath 
             cmd2_build:            powershell ./autobuild/windows/installer/auto_2_build_installer.ps1 -sourcepath 
             cmd3_postbuild:        false
             uses_codeql:           true
             artifact_severity:     "warn"
             
           #- config_name:           AndroidAPK (artifact)
           #  target_os:             android
           #  building_on_os:        ubuntu-18.04
           #  asset_path:            android-build/build/outputs/apk/debug/android-build-debug.apk
           #  asset_name:            jamulus_${{ needs.create_release.outputs.version_name }}_android.apk
           #  cmd1_prebuild:         false
           #  cmd2_build:            false
           #  cmd3_postbuild:        false
           #  uses_codeql:           false
           #  artifact_severity:     "error"
             
           - config_name:           AndroidAPK (artifact+codeql)
             target_os:             android
             building_on_os:        ubuntu-18.04
             asset_path:            android-build/build/outputs/apk/debug/android-build-debug.apk
             asset_name:            jamulus_${{ needs.create_release.outputs.version_name }}_android.apk
             cmd1_prebuild:         "sh autobuild/android/autobuild_apk_1_prepare.sh "
             cmd2_build:            "sh autobuild/android/autobuild_apk_2_build.sh "
             cmd3_postbuild:        "sh autobuild/android/autobuild_apk_3_copy_files.sh "
             uses_codeql:           true
             artifact_severity:     "error"
         
    runs-on:                        ${{ matrix.config.building_on_os }}
    steps:
      # Checkout code
      - name:                       Checkout code
        uses:                       actions/checkout@v2
        with:
          submodules:               true
          
      # Prepare (install QT & dependencies)
      - name:                       "Prepare for ${{ matrix.config.config_name }}"
        if:                         ${{ matrix.config.cmd1_prebuild }}
        run:                        ${{ matrix.config.cmd1_prebuild }} ${{ github.workspace }}
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'  # allow setting environment variables
          
      # Initialize CodeQL tools for code-scanning for security
      - name:                       Initialize CodeQL
        if:                         matrix.config.uses_codeql 
        uses:                       github/codeql-action/init@v1
        with:
          languages: 'cpp' 
          # CodeQL supports [ 'cpp', 'csharp', 'go', 'java', 'javascript', 'python' ]
          # Learn more:
          # https://docs.github.com/en/free-pro-team@latest/github/finding-security-vulnerabilities-and-errors-in-your-code/configuring-code-scanning#changing-the-languages-that-are-analyzed

      # Build
      - name:                       "Build for ${{ matrix.config.config_name }}"
        if:                         ${{ matrix.config.cmd2_build }} 
        run:                        ${{ matrix.config.cmd2_build }} ${{ github.workspace }}
        
      #- name:                       "Build (Android with *uses*)"
      #  if:                         matrix.config.target_os == 'android'   
      #  uses:                       ./autobuild/android/ # Uses an action in the directory
        
      - name:                       "Post-Build for ${{ matrix.config.config_name }}"
        if:                         ${{ matrix.config.cmd3_postbuild }}
        run:                        ${{ matrix.config.cmd3_postbuild }} ${{ github.workspace }}
        env:
          jamulus_version_name:     ${{ needs.create_release.outputs.version_name }}

      # Upload Artifact to Job
      - name:                       Upload Artifact to Job
        uses:                       actions/upload-artifact@v2
        with:
          #name:                     ${{ matrix.config.asset_name }}
          path:                     ${{ matrix.config.asset_path }}
          if-no-files-found:        ${{ matrix.config.artifact_severity }} # 'error ', 'warn', 'ignore', defaults to `warn`
          retention-days:           14
          
      # Run CodeQL tools for code-scanning for security
      - name:                       Perform CodeQL Analysis
        if:                         matrix.config.uses_codeql   
        uses:                       github/codeql-action/analyze@v1
        
        
      # Upload Artifact to Release
      - name:                       Upload Artifact to Release
        if:                         ${{ contains(needs.create_release.outputs.publish_to_release, 'true') }}
        id:                         upload-release-asset
        uses:                       actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN:             ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url:               ${{ needs.create_release.outputs.upload_url }} # See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path:               ${{ matrix.config.asset_path }}
          asset_name:               ${{ matrix.config.asset_name }}
          asset_content_type:       application/octet-stream
          
  ## Builds a Linux flatpack ##
  flatpak-builder:
    name: "Build Flatpak (artifact)"
    if:                         ${{ contains(needs.create_release.outputs.build_flatpack, 'true') }}
    runs-on: ubuntu-latest
    needs: [create_release]
    container:
      image: docker.io/bilelmoussaoui/flatpak-github-actions
      options: --privileged
    steps:
    - uses: actions/checkout@v2
    - name:                       Change branch name in manifest
      run:                        python3 io.jamulus.Jamulus.prepare.py $GITHUB_SHA
      working-directory:          ./distributions/
    - uses:                       bilelmoussaoui/flatpak-github-actions@v2
      with:
        bundle:                   "io.jamulus.Jamulus.flatpak"
        manifest-path:            "distributions/io.jamulus.Jamulus.json"
        
    # download artifact
    - uses:                       actions/download-artifact@v2
      with:
        name:                     io.jamulus.Jamulus
        path:                     ~/io.jamulus.Jamulus
        
    # Upload Artifact to Release
    - name:                       Upload Flatpack
      if:                         ${{ contains(needs.create_release.outputs.publish_to_release, 'true') }}
      id:                         upload-release-asset
      uses:                       actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN:             ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url:               ${{ needs.create_release.outputs.upload_url }} # See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
        asset_path:               /github/home/io.jamulus.Jamulus/io.jamulus.Jamulus.flatpak
        asset_name:               io.jamulus.Jamulus.flatpak
        asset_content_type:       application/octet-stream